- name: Install Zabbix repository
  ansible.builtin.dnf:
    name: https://repo.zabbix.com/zabbix/5.0/rhel/8/x86_64/zabbix-release-5.0-4.el8.noarch.rpm
    state: present
    disable_gpg_check: yes

- name: Clean all dnf cache
  command: dnf clean all

- name: Install Zabbix proxy
  yum:
    name: zabbix-proxy-mysql
    state: present

- name: Ensure MySQL is installed
  yum:
    name: mysql-server
    state: present

- name: Start and enable MySQL service
  service:
    name: mysqld
    state: started
    enabled: yes

- name: Create initial database
  mysql_db:
    name: zabbix_proxy
    state: present
    encoding: utf8
    collation: utf8_bin

- name: Create Zabbix database user
  mysql_user:
    name: zabbix
    password: "{{ db_zabbix_password }}"
    priv: "zabbix_proxy.*:ALL"
    host: localhost
    state: present

- name: Set global log_bin_trust_function_creators
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 1

- name: Import initial schema and data
  command: zcat /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz | mysql -uzabbix -p{{ db_zabbix_password }} zabbix_proxy
  args:
    creates: /usr/share/doc/zabbix-proxy-mysql*/schema.sql.gz

- name: Disable log_bin_trust_function_creators
  mysql_variables:
    variable: log_bin_trust_function_creators
    value: 0

- name: Configure the database for Zabbix proxy
  lineinfile:
    path: /etc/zabbix/zabbix_proxy.conf
    regexp: '^DBPassword='
    line: 'DBPassword={{ db_zabbix_password }}'
    state: present

- name: Start Zabbix proxy process
  systemd:
    name: zabbix-proxy
    state: restarted
    enabled: yes
